#!/usr/local/sbin/tac_plus-ng
id = spawnd {
	listen = { port = 49 }
	spawn = {
		instances min = 1
		instances max = 5
	}
	background = no
}
id = tac_plus-ng {
	log authzlog { destination = /var/log/tac_plus-ng_authz.log }
	log authclog { destination = /var/log/tac_plus-ng_authc.log }
	log acctlog { destination = /var/log/tac_plus-ng_acct.log }
	accounting log = acctlog
	authentication log = authclog
	authorization log = authzlog
	mavis module = groups {
		groups filter = /^(admins|readonly|auditors)$/ # these are defined below
		memberof filter = /^CN=/ # use thisas a prefix
	}
	mavis module = external {
		setenv LDAP_SERVER_TYPE = "microsoft"
		setenv LDAP_HOSTS = "ldaps://int.domain.com:636"
		setenv LDAP_BASE = "dc=int,dc=domain,dc=com"
		setenv LDAP_USER = "bind-tacacs@int.domain.com"
		setenv LDAP_PASSWD = "passwd"
		setenv TACACS_GROUP_PREFIX = ""
		setenv UNLIMIT_AD_GROUP_MEMBERSHIP = 1
		setenv REQUIRE_TACACS_GROUP_PREFIX = 0
		exec = /usr/local/lib/mavis/mavis_tacplus_ldap.pl
	}
	login backend = mavis
	user backend = mavis
 	pap backend = mavis
	ms-chap backend = mavis
	
	
	device = devicetype1 {
		address file = /etc/tacplus-ng/devicetype1 
		welcome banner = "Welcome\n to the machine"
		anonymous-enable = deny # ask for user authentication on enable
		key = key1
	}
	device = devicetype2 {
		address file = /etc/tacplus-ng/devicetype2
		welcome banner = "Welcome\n to the machine"
		anonymous-enable = deny # ask for user authentication on enable
		key = key2
	}
	device = devicetype3 {
		address file = /etc/tacplus-ng/devicetype3
		welcome banner = "Welcome\n to the machine"
		anonymous-enable = deny # ask for user authentication on enable
		key = key3
	}

        device = others {
                address = 127.0.0.1
                key = hello
        } 
	profile dev1-admins {
		script {
			if (service == shell) {
				if (cmd == "") {
				set priv-lvl = 15
				permit
				}
				permit
								}
				}
	}
	profile dev2-admins {
		script {
		   if (service == ppp) {
		   if (protocol == ip) {
			   set F5-LTM-User-Info-1 = adm
			   set F5-LTM-User-Console = 1
			   set F5-LTM-User-Role = 0
			   set F5-LTM-User-Partition = all
			   permit
							 }
                           permit
						   }
				}
	}
	profile dev2-auditor {
		script {
		   if (service == ppp) {
		   if (protocol == ip) {
			   set F5-LTM-User-Info-1 = auditor
			   set F5-LTM-User-Console = 1
			   set F5-LTM-User-Role = 80
			   set F5-LTM-User-Partition = common
			   permit
							 }
                           permit
						   }
				}
	}

        profile dev3-admin {
                enable 15 = login
                script {
                   if (service == pap) {
                      if (cmd == "") {
                           set priv-lvl = 15
                           permit
                                                         }
                           permit
                                                   }
                                }
        }

        profile dev3-auditor {
                enable 15 = clear login
                script {
                   if (service == pap) {
                      if (cmd == "") {
                           set priv-lvl = 0
                           permit
                                                         }
                           permit
                                                   }
                                }
        }


	profile readonly {
		enable = deny
		script {
			if (service == shell) {
		  	set priv-lvl = 1
		  	if (cmd =~ /^show.*/){
			permit
		  						}
		   					}
	  			}
	}
	profile dev1-auditors {
		enable = deny
		script {
			if (service == shell) {
			if (cmd == "") 
			set priv-lvl = 19
			permit
		   					  }
	  		 }
	}
	ruleset {
		rule {
			script {
                                if (device == devicetype1) {
 
				if (memberof =~ /^CN=dev1admins,/) { profile = dev1-admins permit }
                                if (memberof =~ /^CN=dev1auditors,/) { profile = dev1-auditors permit }
                                if (memberof =~ /^CN=dev1readonly,/) { profile = readonly permit }
                                                     }

                                if (device == devicetype2) {
				if (memberof =~ /^CN=dev2admins,/) { profile = dev2-admins permit }
                                if (memberof =~ /^CN=dev2auditors,/) { profile = dev2-auditor permit }
                                                  }

                                if (device == devicetype3) {
				if (memberof =~ /^CN=dev3admin,/) { profile = dev3-admin permit }
				if (memberof =~ /^CN=dev3admin2,/) { profile = dev3-admin permit }
                                if (memberof =~ /^CN=dev3auditor,/) { profile = dev3-auditor permit }
                                if (memberof =~ /^CN=dev3readonly,/) { profile = dev3-auditor permit }
                                if (memberof =~ /^CN=dev3mgmt,/) { profile = dev3-auditor permit }
                                                  }
                                if (device == others) { 
                                if (memberof =~ /^CN=dev4-admins,/) { profile = dev1-admins permit }
				if (memberof =~ /^CN=dev4-readonly,/) { profile = readonly permit }
}			
		}
			}
			}
	}
